# MPI+OpenMP GPU-Aware communication

When building multi-GPU Fortran applications, you may want to know at run-time whether or not the system you are running on provides GPU-aware MPI. Both OpenMPI and MVAPICH2-GDR provide the `MPIX_Query_rocm_support()` and `MPIX_Query_cuda_support()` functions in C and the Fortran syntax is not supported. To work around this, we can use the language interoperability feature in Fortran, through ISO C Binding, to expose this method to Fortran.

OpenMP can handle memory management and kernel execution on the GPU. The `amdflang` compiler provides an OpenMP 4.5 compliant compiler for enabling GPU offloading in Fortran. When combining MPI+OpenMP for multi-GPU offloading, you must build the Fortran bindings for your MPI installation with the same compiler; this requirement stems from the notorious incompatibility of Fortran object and module files generated by different Fortran compilers.

## What's included
This example includes the following files

* `openmpi_gpu_support.cpp` - A simple C++ file that provides a wrapper for `MPIX_Query_rocm_support` and `MPIX_Query_cuda_support` that is simply called `MPIX_Query_gpu_support`. If either ROCm or CUDA aware support is detected, the function returns `true`; otherwise `false`.
* `openmpi_gpu_support.f90` - A simple fortran module that defines a Fortran interface that binds to the `MPIX_Query_gpu_support` C++ function. This module allows us to call `MPIX_Query_gpu_support` as if it were a Fortran function that returns a fortran `logical`
* `main.f90` - An adapation of a MPI-Fortran Hello World program that issues a call to our `MPIX_Query_gpu_support` function and handle MPI exchange on the GPU using openmp.
* `Makefile` - A quick n' dirty makefile to help you build the application.


## Before you try it out

We recommend that you [install OpenMPI v5.0.x with GPU aware support](https://fluidnumerics.github.io/gpu-programming/MPIplus/GetStartedwithOMPI). Particularly, you want to build OpenMPI with the `amdclang`, `amdclang++`, and `amdflang` compilers; see our [`install_openmpi_with_amdflang.sh` script](https://github.com/FluidNumerics/gpu-programming/blob/main/util/install_openmpi_with_amdflang.sh)


## To demo this example

```
$ make
mpic++ -O0 -g -c openmpi_gpu_support.cpp -o openmpi_gpu_support.cpp.o
mpif90 -O0 -g -c openmpi_gpu_support.f90 -o openmpi_gpu_support.f90.o
mpif90 -O0 -g -fopenmp -fopenmp-targets=amdgcn-amd-amdhsa -Xopenmp-target=amdgcn-amd-amdhsa -march=gfx90a -c main.f90 -o main.f90.o
mpif90 -O0 -g -fopenmp -fopenmp-targets=amdgcn-amd-amdhsa -Xopenmp-target=amdgcn-amd-amdhsa -march=gfx90a main.f90.o openmpi_gpu_support.f90.o openmpi_gpu_support.cpp.o -lstdc++ -o gpu_aware_test
mpic++ -O0 -g -cpp -c openmpi_gpu_support.cpp -o openmpi_gpu_support.cpp.o
mpif90 -O0 -g -c openmpi_gpu_support.f90 -o openmpi_gpu_support.f90.o
mpif90 -v -O0 -g -c main.f90 -o main.f90.o
/usr/bin/gfortran  -g  -c -cpp -I/opt/rocm/include/hipfort/amdgcn  main.f90  -I/opt/software/ompi/include -I/opt/software/ompi/lib  -o /home/joe/gpu-programming/samples/fortran/mpi+hipfort/main.f90.o
#Info:  Temp files kept in /tmp


$ mpirun -np 2 -x UCX_TLS=sm,self,rocm --mca pml ucx ./gpu_aware_test 
 Hello World from process:            1 of            2
 GPU aware MPI detected!
 Hello World from process:            0 of            2
 GPU aware MPI detected!
 rank 1 : data received correctly!
```

## Modifying for your system
If you have a different AMD GPU, you can change the `GPU_ARCH` variable to the appropriate architecture for your system. Simply edit the provided Makefile to set `GPU_ARCH` to any of the following

* `gfx90a` - for MI210, MI250, and MI250X GPUs
* `gfx908` - for MI100 GPUs
* `gfx906` - for MI50 GPUs
